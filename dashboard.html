<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="theme.js"></script>
</head>
<body class="light-mode">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">Dashboard</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <span id="logged-in-username" class="nav-link logged-in-username"></span>
                </li>
            </ul>
            <div id="nav-links" class="navbar-nav">
                <!-- Dynamic navigation links will be inserted here by dashboard.js -->
            </div>
            <div class="navbar-nav ml-auto">
                <div class="nav-item dropdown mr-2">
                    <a class="nav-link" href="#" id="notifDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        <span id="notif-count" class="badge badge-danger ml-1">0</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="notifDropdown" style="min-width: 320px;">
                        <h6 class="dropdown-header">Notifications</h6>
                        <div id="notif-list" style="max-height: 280px; overflow-y: auto;"></div>
                    </div>
                </div>
                <button id="theme-toggle" class="btn btn-outline-light theme-toggle-button mr-2">
                    <i id="theme-toggle-dark-icon" class="fas fa-moon theme-icon"></i>
                    <i id="theme-toggle-light-icon" class="fas fa-sun theme-icon hidden"></i>
                </button>
                <button id="logout-button" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </nav>
    <div class="container mt-4" id="dashboard-content">
        <!-- Content will be dynamically loaded here -->
    </div>
    <!-- View Templates -->
    <template id="tpl-admin-dashboard">
        <div>
            <div class="row">
                <div class="col-12 col-md-4 mb-4">
                    <div class="card text-white bg-primary h-100 shadow">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-users mr-2"></i>Total Users</h5>
                            <h2 id="admin-users-count" class="display-4 mb-0">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-4">
                    <div class="card text-white bg-success h-100 shadow">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-file-invoice-dollar mr-2"></i>Total Payments</h5>
                            <h2 id="admin-payments-count" class="display-4 mb-0">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-4">
                    <div id="card-total-amount" class="card text-white bg-info h-100 shadow clickable">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-dollar-sign mr-2"></i>Total Amount</h5>
                            <h2 id="admin-total-amount" class="display-4 mb-0">0.00</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-6 mb-4">
                    <div id="card-total-loan-issued" class="card text-white bg-secondary h-100 shadow clickable">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-hand-holding-usd mr-2"></i>Total Loan Issued</h5>
                            <h2 id="admin-total-loan-issued" class="display-4 mb-0">0.00</h2>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 mb-4">
                    <div id="card-remaining-balance" class="card text-white bg-warning h-100 shadow clickable">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-wallet mr-2"></i>Remaining Balance</h5>
                            <h2 id="admin-remaining-balance" class="display-4 mb-0">0.00</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-dark text-white">
                    <h2 class="mb-0"><i class="fas fa-bell mr-2"></i>Recent Notifications</h2>
                </div>
                <div class="card-body">
                    <div id="notification-list"></div>
                </div>
            </div>
            <h2 class="mt-4 mb-3 section-title">User Overview</h2>
            <div class="row" id="user-overview-cards"></div>
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">
                    <h2 class="mb-0"><i class="fas fa-money-bill-wave mr-2"></i>All Payments Overview</h2>
                </div>
                <div class="card-body">
                    <button id="download-all-payments-excel-admin" class="btn btn-success mb-3"><i class="fas fa-file-excel mr-2"></i>Download All Payments as Excel</button>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Payment Date</th>
                                    <th>Payment Method</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="all-payments-list-admin"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="tpl-admin-users">
        <div class="row">
            <div class="col-12 col-md-5 mb-4">
                <div class="card shadow-lg">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0" id="user-form-title"><i class="fas fa-user-plus mr-2"></i>Create User</h2>
                    </div>
                    <div class="card-body">
                        <form id="user-form">
                            <input type="hidden" id="original-username">
                            <div class="form-group">
                                <label for="new-username"><i class="fas fa-user mr-2"></i>Username</label>
                                <input id="new-username" type="text" class="form-control" placeholder="Username">
                            </div>
                            <div class="form-group">
                                <label for="new-password"><i class="fas fa-lock mr-2"></i>Password</label>
                                <input id="new-password" type="password" class="form-control" placeholder="Leave blank to keep current password">
                            </div>
                            <div class="form-group">
                                <label for="role"><i class="fas fa-user-tag mr-2"></i>Role</label>
                                <select id="role" class="form-control">
                                    <option value="user">User</option>
                                    <option value="accountant">Accountant</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-actions text-center">
                                <button id="user-form-submit" type="submit" class="btn btn-primary"><i class="fas fa-plus-circle mr-2"></i>Create User</button>
                                <button id="cancel-edit" type="button" class="btn btn-secondary ml-2 hidden"><i class="fas fa-times-circle mr-2"></i>Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-7 mb-4">
                <div class="card shadow-lg">
                    <div class="card-header bg-dark text-white">
                        <h2 class="mb-0"><i class="fas fa-users-cog mr-2"></i>Users Management</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover data-table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <!-- Accountant Deposit (Collections) Template -->
    <template id="tpl-accountant-deposit">
        <div>
            <h2 class="section-title mb-4"><i class="fas fa-money-check-alt mr-2"></i>Add Payment</h2>
            <div class="card shadow mb-4">
                <div class="card-body">
                    <form id="payment-form">
                        <div class="form-group">
                            <label for="user-select"><i class="fas fa-user mr-2"></i>User</label>
                            <select id="user-select" class="form-control"></select>
                        </div>
                        <div class="form-group">
                          <label class="mr-3"><input type="radio" name="payment-type" value="deposit" checked> Deposit</label>
                          <label><input type="radio" name="payment-type" value="emi"> Pay EMI</label>
                        </div>
                        <div id="deposit-fields">
                          <div class="form-group">
                              <label for="amount"><i class="fas fa-dollar-sign mr-2"></i>Deposit Amount</label>
                              <input id="amount" type="number" class="form-control" placeholder="Amount">
                          </div>
                          <div class="form-group">
                              <label for="payment-date"><i class="fas fa-calendar-alt mr-2"></i>Date of Deposit</label>
                              <input id="payment-date" type="date" class="form-control">
                          </div>
                          <div class="form-group">
                              <label for="payment-method"><i class="fas fa-credit-card mr-2"></i>Payment Method</label>
                              <input id="payment-method" type="text" class="form-control" placeholder="e.g., Cash, Bank, Transfer">
                          </div>
                          <div class="form-group">
                              <label for="deposit-notes"><i class="fas fa-sticky-note mr-2"></i>Notes</label>
                              <textarea id="deposit-notes" class="form-control" placeholder="Optional notes"></textarea>
                          </div>
                        </div>
                        <div id="emi-fields" class="d-none">
                          <div class="form-group">
                              <label for="emi-loan-select"><i class="fas fa-hand-holding-usd mr-2"></i>Select Loan</label>
                              <select id="emi-loan-select" class="form-control"></select>
                          </div>
                          <div class="form-group">
                              <label for="emi-installment-select"><i class="fas fa-list-ol mr-2"></i>Select Installment</label>
                              <select id="emi-installment-select" class="form-control"></select>
                          </div>
                          <div class="form-group">
                              <label for="emi-amount"><i class="fas fa-coins mr-2"></i>Amount</label>
                              <input id="emi-amount" type="number" step="0.01" class="form-control" placeholder="Auto-filled from installment">
                          </div>
                          <div class="form-group">
                              <label for="emi-method"><i class="fas fa-credit-card mr-2"></i>Payment Method</label>
                              <input id="emi-method" type="text" class="form-control" placeholder="e.g., Cash, Bank, Transfer">
                          </div>
                          <div class="form-group">
                              <label for="emi-date"><i class="fas fa-calendar-alt mr-2"></i>Payment Date</label>
                              <input id="emi-date" type="date" class="form-control">
                          </div>
                          <div class="form-group">
                              <label for="emi-notes"><i class="fas fa-sticky-note mr-2"></i>Notes</label>
                              <textarea id="emi-notes" class="form-control" placeholder="Optional notes"></textarea>
                          </div>
                        </div>
                        <div class="form-actions text-center">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Submit Payment</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">
                    <h2 class="mb-0"><i class="fas fa-bell mr-2"></i>Send Notification</h2>
                </div>
                <div class="card-body">
                    <form id="notification-form">
                        <div class="form-group">
                            <label for="notification-user-select"><i class="fas fa-user mr-2"></i>User</label>
                            <select id="notification-user-select" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="notification-message"><i class="fas fa-comment-dots mr-2"></i>Message</label>
                            <textarea id="notification-message" class="form-control" placeholder="Type your message"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane mr-2"></i>Send</button>
                    </form>
                </div>
            </div>
        </div>
    </template>
    <!-- Loans & EMIs Template -->
    <template id="tpl-loans-emis">
        <div>
            <h2 class="section-title mb-4"><i class="fas fa-hand-holding-usd mr-2"></i>Loans & EMIs</h2>
            <div class="row">
                <div class="col-md-5">
                    <div class="card shadow mb-4">
                        <div class="card-header bg-dark text-white">Issue Loan</div>
                        <div class="card-body">
                            <form id="loan-form">
                                <div class="form-group">
                                    <label for="loan-user"><i class="fas fa-user mr-2"></i>Member Name / ID</label>
                                    <select id="loan-user" class="form-control"></select>
                                </div>
                                <div class="form-group">
                                    <label for="loan-purpose"><i class="fas fa-align-left mr-2"></i>Loan Purpose</label>
                                    <input id="loan-purpose" type="text" class="form-control" placeholder="e.g., Medical expense">
                                </div>
                                <div class="form-group">
                                    <label for="loan-amount"><i class="fas fa-coins mr-2"></i>Loan Amount</label>
                                    <input id="loan-amount" type="number" step="0.01" class="form-control" placeholder="e.g., 50000" required>
                                </div>
                                <div class="form-group">
                                    <label for="loan-duration"><i class="fas fa-hourglass-half mr-2"></i>Duration (Months)</label>
                                    <input id="loan-duration" type="number" class="form-control" placeholder="e.g., 12" required>
                                </div>
                                <div class="form-group">
                                    <label for="loan-rate"><i class="fas fa-percent mr-2"></i>Interest Rate (%)</label>
                                    <input id="loan-rate" type="number" step="0.01" class="form-control" placeholder="e.g., 12" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col">
                                        <label for="loan-window-start"><i class="fas fa-calendar-day mr-2"></i>Installment Window (From Day)</label>
                                        <input id="loan-window-start" type="number" class="form-control" value="1">
                                    </div>
                                    <div class="form-group col">
                                        <label for="loan-window-end"><i class="fas fa-calendar-day mr-2"></i>To Day</label>
                                        <input id="loan-window-end" type="number" class="form-control" value="10">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="loan-start-date"><i class="fas fa-calendar-alt mr-2"></i>Start Date (optional)</label>
                                    <input id="loan-start-date" type="date" class="form-control">
                                </div>
                                <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-paper-plane mr-2"></i>Submit</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card shadow mb-4">
                        <div class="card-header bg-info text-white">Loan Details</div>
                        <div class="card-body" id="loan-details">
                            <p class="text-muted">Submit a loan to see details and schedule preview here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Accountant Dashboard Template -->
    <template id="tpl-accountant-dashboard">
        <div>
            <div class="row">
                <div class="col-12 col-md-4 mb-4">
                    <div class="card text-white bg-primary h-100 shadow">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-file-invoice-dollar mr-2"></i>Total Payments</h5>
                            <h2 id="ac-payments-count" class="display-4 mb-0">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-4">
                    <div id="ac-card-total-amount" class="card text-white bg-info h-100 shadow clickable">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-dollar-sign mr-2"></i>Total Amount</h5>
                            <h2 id="ac-total-amount" class="display-4 mb-0">0.00</h2>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-4">
                    <div class="card text-white bg-warning h-100 shadow">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-bell mr-2"></i>Recent Notifications Sent</h5>
                            <h2 id="ac-notif-count" class="display-4 mb-0">0</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-6 mb-4">
                    <div id="ac-card-total-loan-issued" class="card text-white bg-secondary h-100 shadow clickable">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-hand-holding-usd mr-2"></i>Total Loan Issued</h5>
                            <h2 id="ac-total-loan-issued" class="display-4 mb-0">0.00</h2>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 mb-4">
                    <div id="ac-card-remaining-balance" class="card text-white bg-warning h-100 shadow clickable">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-wallet mr-2"></i>Remaining Balance</h5>
                            <h2 id="ac-remaining-balance" class="display-4 mb-0">0.00</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-dark text-white">
                    <h2 class="mb-0"><i class="fas fa-bell mr-2"></i>Recent Notifications</h2>
                </div>
                <div class="card-body"><div id="ac-notification-list"></div></div>
            </div>
            <h2 class="mt-4 mb-3 section-title">User Overview</h2>
            <div class="row" id="ac-user-overview-cards"></div>
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">
                    <h2 class="mb-0"><i class="fas fa-money-bill-wave mr-2"></i>All Payments</h2>
                </div>
                <div class="card-body">
                    <button id="ac-download-all-payments-excel" class="btn btn-success mb-3"><i class="fas fa-file-excel mr-2"></i>Download All Payments as Excel</button>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Payment Date</th>
                                    <th>Payment Method</th>
                                </tr>
                            </thead>
                            <tbody id="ac-all-payments-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- User Dashboard Template -->
    <template id="tpl-user-dashboard">
        <div>
            <div class="row">
                <div class="col-md-6 offset-md-3 mb-4">
                    <div class="card text-white bg-success h-100 shadow">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-dollar-sign mr-2"></i>Total Deposited</h5>
                            <h2 id="user-total-deposited" class="display-4 mb-0">0.00</h2>
                        </div>
                    </div>
                </div>
            </div>
            <h2 class="section-title mb-4"><i class="fas fa-history mr-2"></i>Payment History</h2>
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter mr-2"></i>Filter Payments</h5>
                </div>
                <div class="card-body">
                    <div class="form-group row">
                        <label for="user-month-filter" class="col-sm-2 col-form-label">Filter by Month:</label>
                        <div class="col-sm-4">
                            <input type="month" id="user-month-filter" class="form-control">
                        </div>
                        <div class="col-sm-6 text-right">
                            <button id="user-download-excel" class="btn btn-success"><i class="fas fa-file-excel mr-2"></i>Download as Excel</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-table mr-2"></i>Payment Details</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover data-table">
                            <thead>
                                <tr>
                                    <th>Amount</th>
                                    <th>Payment Date</th>
                                    <th>Payment Method</th>
                                </tr>
                            </thead>
                            <tbody id="user-payments-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <!-- User Payment Details Template -->
    <template id="tpl-user-details">
        <div>
            <h2 class="section-title mb-4">Payment History for <span id="user-details-username"></span></h2>
            <button id="back-to-admin-dashboard" class="btn btn-secondary mb-3"><i class="fas fa-arrow-left mr-2"></i>Back to Dashboard</button>
            <div class="card shadow mb-4" id="user-deductions-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-minus-circle mr-2"></i>Money Deducted</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead><tr><th>Date</th><th>Amount</th><th>Type</th><th>Reason</th><th>Loan</th></tr></thead>
                            <tbody id="user-deductions-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card shadow mb-4" id="user-loans-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-hand-holding-usd mr-2"></i>Loans Taken</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead><tr><th>Purpose</th><th>Principal</th><th>Status</th><th>Next EMI</th></tr></thead>
                            <tbody id="user-loans-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter mr-2"></i>Filter Payments</h5>
                </div>
                <div class="card-body">
                    <div class="form-group row">
                        <label for="month-filter" class="col-sm-2 col-form-label">Filter by Month:</label>
                        <div class="col-sm-4">
                            <input type="month" id="month-filter" class="form-control">
                        </div>
                        <div class="col-sm-6 text-right">
                            <button id="download-user-excel" class="btn btn-success"><i class="fas fa-file-excel mr-2"></i>Download as Excel</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-table mr-2"></i>Payment Details</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover data-table">
                            <thead>
                                <tr>
                                    <th>Amount</th>
                                    <th>Payment Date</th>
                                    <th>Payment Method</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-payment-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <script type="module" src="dashboard.js"></script>
    <script src="/public/exportUtil.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <!-- Edit Payment Modal -->
    <!-- Loans List Modal (moved from JS template) -->
    <div class="modal fade" id="loansModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Loans List</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <form id="loans-filter" class="form-inline">
                            <label class="mr-2">Status</label>
                            <select id="loans-status" class="form-control form-control-sm mr-2">
                                <option value="active,closed" selected>Active + Closed</option>
                                <option value="active">Active</option>
                                <option value="closed">Closed</option>
                            </select>
                            <label class="mr-2">From</label>
                            <input id="loans-from" type="date" class="form-control form-control-sm mr-2" />
                            <label class="mr-2">To</label>
                            <input id="loans-to" type="date" class="form-control form-control-sm mr-2" />
                            <button class="btn btn-primary btn-sm" type="submit">Apply</button>
                        </form>
                        <div>
                            <button id="export-loans-xlsx" class="btn btn-success btn-sm mr-2">
                                <i class="fas fa-file-excel mr-1"></i>Export XLSX
                            </button>
                            <button id="export-loans-csv" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-file-csv mr-1"></i>Export CSV
                            </button>
                            <button id="export-loans-server" class="btn btn-outline-primary btn-sm ml-2">
                                <i class="fas fa-cloud-download-alt mr-1"></i>Server Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="loans-list-table">
                            <thead>
                                <tr>
                                    <th>Borrower</th>
                                    <th>Purpose</th>
                                    <th>Principal</th>
                                    <th>Issued</th>
                                    <th>Next EMI Due</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Balances Modal (moved from JS template) -->
    <div class="modal fade" id="balancesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Per-user Balances</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="balances-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Balance</th>
                                    <th>Last Txn</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="export-balances-xlsx" class="btn btn-success">
                        <i class="fas fa-file-excel mr-2"></i>Export
                    </button>
                    <!-- CSV button is created by JS to avoid duplication -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Amount – Breakdown Modal (moved from JS template) -->
    <div class="modal fade" id="totalAmountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Total Amount – Breakdown</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#tab-interest" role="tab">Per-User Interest Earned</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#tab-closures" role="tab">Loan Closure History</a>
                        </li>
                    </ul>
                    <div class="tab-content pt-3">
                        <div class="tab-pane fade show active" id="tab-interest" role="tabpanel">
                            <div class="d-flex justify-content-end mb-2">
                                <button id="export-interest-xlsx" class="btn btn-success btn-sm mr-2">
                                    <i class="fas fa-file-excel mr-1"></i>Export XLSX
                                </button>
                                <button id="export-interest-csv" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-file-csv mr-1"></i>Export CSV
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped" id="interest-table">
                                    <thead>
                                        <tr>
                                            <th>Loan</th>
                                            <th>User</th>
                                            <th>Interest Share</th>
                                            <th>From</th>
                                            <th>To</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-closures" role="tabpanel">
                            <div class="d-flex justify-content-end mb-2">
                                <button id="export-closures-xlsx" class="btn btn-success btn-sm mr-2">
                                    <i class="fas fa-file-excel mr-1"></i>Export XLSX
                                </button>
                                <button id="export-closures-csv" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-file-csv mr-1"></i>Export CSV
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped" id="closures-table">
                                    <thead>
                                        <tr>
                                            <th>Loan</th>
                                            <th>Borrower</th>
                                            <th>Total Interest</th>
                                            <th>Closed</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editPaymentModal" tabindex="-1" aria-labelledby="editPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPaymentModalLabel">Edit Payment</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-payment-form">
                        <input type="hidden" id="edit-payment-id">
                        <div class="form-group">
                            <label for="edit-username">Username</label>
                            <input type="text" class="form-control" id="edit-username" readonly>
                        </div>
                        <div class="form-group">
                            <label for="edit-amount">Amount</label>
                            <input type="number" class="form-control" id="edit-amount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-paymentDate">Payment Date</label>
                            <input type="date" class="form-control" id="edit-paymentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-paymentMethod">Payment Method</label>
                            <input type="text" class="form-control" id="edit-paymentMethod" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/node_modules/socket.io-client/dist/socket.io.js"></script>
</body>
</html>
